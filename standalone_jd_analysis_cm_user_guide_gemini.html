<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Description Deep Dive - Standalone AI Tool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* JD Analyzer Standalone Styles */
        :root {
            --primary-color: #0097d7; /* Updated to Requested Blue */
            --primary-dark: #0072a3;  /* Darker shade of #0097d7 for gradients */
            --secondary-color: #64748b;
            --success-color: #059669;
            --warning-color: #f68710; /* Updated to Requested Orange */
            --error-color: #dc2626;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
            --border-radius: 8px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --transition: all 0.2s ease-in-out;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 0;
            border-bottom: 4px solid rgba(0,0,0,0.1);
        }

        .header-content h1 {
            font-size: 2.2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .status-dot { font-size: 0.6rem; }
        .status-dot.connected { color: #86efac; }
        .status-dot.disconnected { color: #fca5a5; }

        /* Tabs Navigation */
        .tabs-container {
            background: white;
            padding: 0 2rem;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .tabs-nav {
            display: flex;
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab-btn {
            padding: 1.5rem 0.5rem;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--warning-color);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-btn:hover { color: var(--primary-color); }
        
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Tab Content Handling */
        .tab-content { 
            display: none; 
            animation: fadeIn 0.3s ease; 
        }
        
        /* Specific display types for active tabs */
        #tab-analyzer.active { 
            display: flex; /* Analyzer needs flex for column layout */
        }
        
        #tab-guide.active { 
            display: block; /* Guide needs block for carousel */
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Main Content Utilities */
        .main-content { 
            /* display: flex; REMOVED to prevent conflict with tab hiding */
            flex-direction: column; 
            gap: 2rem; 
            padding-bottom: 4rem; 
        }

        section {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        h2, h3 { color: var(--warning-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }

        /* LM Studio Config */
        .mode-section {
            background: #e0f2fe; /* Light blue tint */
            border: 1px solid #bae6fd;
        }
        
        .api-config {
            background: #fff;
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .config-row { display: flex; gap: 1rem; margin-bottom: 1rem; align-items: flex-end; }
        .config-col-full { flex: 1; width: 100%; }
        
        /* Inputs */
        .input-group label {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-textarea {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-family: 'Inter', monospace;
            resize: vertical;
            min-height: 250px;
            transition: var(--transition);
        }

        .form-textarea:focus, .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 151, 215, 0.1);
        }

        .form-input, .form-select {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            width: 100%;
        }

        .char-count { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem; text-align: right; display: block;}

        /* Options Grid */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .checkbox-label {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            cursor: pointer;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .checkbox-label:hover { background: #f0f9ff; border-color: var(--primary-color); }
        .checkbox-label input[type="checkbox"] { margin-top: 0.25rem; }
        
        .checkbox-info {
            display: flex;
            flex-direction: column;
        }
        .checkbox-title { font-weight: 600; font-size: 0.95rem; }
        .checkbox-desc { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.2rem; }

        /* Buttons */
        .action-section { display: flex; gap: 1rem; justify-content: center; margin-top: 1rem; }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-secondary { background: var(--secondary-color); color: white; }
        .btn-secondary:hover:not(:disabled) { background: #475569; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }

        /* Results */
        .analysis-output {
            padding: 2rem;
            background: #ffffff;
            line-height: 1.7;
            border-radius: var(--border-radius);
        }

        .analysis-output h1 { font-size: 1.8rem; color: var(--primary-color); border-bottom: 2px solid #e0e7ff; padding-bottom: 0.5rem; margin-top: 2rem; }
        .analysis-output h2 { font-size: 1.4rem; color: var(--text-primary); margin-top: 1.5rem; border-left: 4px solid var(--primary-color); padding-left: 1rem; }
        .analysis-output h3 { font-size: 1.2rem; color: #4b5563; margin-top: 1.2rem; }
        .analysis-output ul, .analysis-output ol { padding-left: 1.5rem; margin: 1rem 0; }
        .analysis-output li { margin-bottom: 0.5rem; }
        .analysis-output strong { color: var(--primary-dark); }
        
        /* --- CAROUSEL STYLES --- */
        .guide-carousel-container {
            position: relative;
            height: 600px; /* Fixed height for consistency */
            width: 100%;
            margin: 0 auto;
            overflow: hidden;
            background: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .guide-track {
            display: flex;
            height: 100%;
            transition: transform 0.5s ease-in-out;
            width: 100%;
        }

        .guide-slide {
            min-width: 100%;
            height: 100%;
            padding: 3rem 4rem;
            overflow-y: auto; /* Allow scroll inside slide if content is too long */
            display: flex;
            flex-direction: column;
            /* justify-content: center; */ /* Let content flow naturally */
        }

        .guide-slide h2 { font-size: 2rem; margin-bottom: 1rem; color: var(--primary-color); }
        .guide-slide h3 { color: var(--text-primary); font-size: 1.3rem; margin-top: 1.5rem; }

        /* Carousel Controls */
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            border: 1px solid var(--border-color);
            color: var(--primary-color);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            z-index: 10;
        }
        .carousel-btn:hover { background: var(--primary-color); color: white; }
        .carousel-btn.prev { left: 20px; }
        .carousel-btn.next { right: 20px; }
        
        .carousel-nav {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        
        .carousel-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #cbd5e1;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .carousel-dot.active { background: var(--primary-color); transform: scale(1.2); }

        /* Guide Content Elements */
        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .guide-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .guide-card {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        .guide-card i { font-size: 2rem; margin-bottom: 1rem; display: block; }

        /* Toast */
        .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 1000; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { padding: 1rem 1.5rem; border-radius: var(--border-radius); color: white; box-shadow: var(--shadow-md); animation: slideIn 0.3s ease; }
        .toast.success { background: var(--success-color); }
        .toast.error { background: var(--error-color); }
        .toast.warning { background: var(--warning-color); } /* Added for orange toasts */
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Loading Spinner */
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .config-row { flex-direction: column; }
            .header-content h1 { font-size: 1.5rem; }
            .tabs-nav { gap: 1rem; overflow-x: auto; padding-bottom: 0.5rem; }
            .guide-slide { padding: 2rem 3rem; } 
            .guide-carousel-container { height: 700px; }
        }
    </style>
    <!-- Library for DOCX export -->
    <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.js"></script>
</head>
<body>
    
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1><i class="fas fa-search-plus"></i> Job Description Deep Analyzer</h1>
                <div class="status-bar">
                    <div class="status-item" id="connection-status">
                        <i class="fas fa-circle status-dot disconnected"></i>
                        <span>LM Studio: Disconnected</span>
                    </div>
                    <div class="status-item" id="model-status">
                        <i class="fas fa-robot"></i>
                        <span>No Model Selected</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabs -->
    <div class="tabs-container">
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="analyzer">
                <i class="fas fa-magic"></i> Analyzer Tool
            </button>
            <button class="tab-btn" data-tab="guide">
                <i class="fas fa-book-open"></i> User Guide
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Main Content: Analyzer Tab -->
        <main id="tab-analyzer" class="tab-content active main-content">
            
            <!-- Connection Config -->
            <section class="mode-section">
                <h2><i class="fas fa-plug"></i> Local Server Configuration</h2>
                <div class="api-config">
                    <div class="config-row">
                        <div class="config-col-full" style="flex: 2;">
                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Base URL</label>
                            <input type="text" id="lm-base-url" class="form-input" value="http://localhost:1234" readonly>
                        </div>
                        <div class="config-col-full" style="flex: 3;">
                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Model Selection</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="lm-model-select" class="form-select">
                                    <option value="">Select a model...</option>
                                </select>
                                <button type="button" id="refresh-models-btn" class="btn btn-secondary" title="Refresh models">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Input Section -->
            <section class="input-section">
                <h2><i class="fas fa-file-alt"></i> Paste Job Description</h2>
                <div class="input-group">
                    <textarea 
                        id="jd-input" 
                        class="form-textarea" 
                        placeholder="Paste the full job description text here..."
                    ></textarea>
                    <span class="char-count" id="jd-char-count">0 characters</span>
                </div>

                <div class="input-group" style="margin-top: 1.5rem;">
                    <label>Additional Context / Specific Questions (Optional)</label>
                    <input 
                        type="text" 
                        id="additional-focus" 
                        class="form-input" 
                        placeholder="e.g., 'Does this mention remote work?', 'Is there Python involved?', 'Analyze for a Junior level applicant'"
                    >
                </div>
            </section>

            <!-- Analysis Options -->
            <section class="options-section">
                <h2><i class="fas fa-tasks"></i> Analysis Modules</h2>
                <div class="options-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" id="opt-core-analysis" checked>
                        <div class="checkbox-info">
                            <span class="checkbox-title">Core Competencies Breakdown</span>
                            <span class="checkbox-desc">Detailed split of hard skills, soft skills, and role expectations.</span>
                        </div>
                    </label>
                    
                    <label class="checkbox-label">
                        <input type="checkbox" id="opt-candidate-persona" checked>
                        <div class="checkbox-info">
                            <span class="checkbox-title">Ideal Candidate Persona</span>
                            <span class="checkbox-desc">Psychological and professional profile of who they really want.</span>
                        </div>
                    </label>

                    <label class="checkbox-label">
                        <input type="checkbox" id="opt-corporate-decoder" checked>
                        <div class="checkbox-info">
                            <span class="checkbox-title">Corporate Jargon Decoder</span>
                            <span class="checkbox-desc">Translate "buzzwords" into actual day-to-day realities.</span>
                        </div>
                    </label>

                    <label class="checkbox-label">
                        <input type="checkbox" id="opt-red-flags">
                        <div class="checkbox-info">
                            <span class="checkbox-title">Red Flags & Culture Check</span>
                            <span class="checkbox-desc">Identify toxic traits, vague requirements, or work-life balance risks.</span>
                        </div>
                    </label>

                    <label class="checkbox-label">
                        <input type="checkbox" id="opt-interview-prep">
                        <div class="checkbox-info">
                            <span class="checkbox-title">Interview Prep Generator</span>
                            <span class="checkbox-desc">Generate likely technical and behavioral questions based on this JD.</span>
                        </div>
                    </label>

                    <label class="checkbox-label">
                        <input type="checkbox" id="opt-salary-est">
                        <div class="checkbox-info">
                            <span class="checkbox-title">Seniority & Market Positioning</span>
                            <span class="checkbox-desc">Estimate seniority level and potential salary bracket based on responsibilities.</span>
                        </div>
                    </label>
                </div>
            </section>

            <!-- Actions -->
            <section class="action-section" style="background: transparent; border: none; box-shadow: none; padding: 0;">
                <button id="analyze-btn" class="btn btn-primary" style="font-size: 1.1rem; padding: 1rem 2rem;">
                    <i class="fas fa-brain"></i> Analyze Job Description
                </button>
                <button id="clear-btn" class="btn btn-secondary">
                    <i class="fas fa-eraser"></i> Clear
                </button>
            </section>

            <!-- Results -->
            <section class="results-section" id="results-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <h2><i class="fas fa-poll"></i> Analysis Results</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="copy-btn" class="btn btn-secondary btn-sm"><i class="fas fa-copy"></i> Copy</button>
                        <button id="export-docx-btn" class="btn btn-secondary btn-sm"><i class="fas fa-file-word"></i> DOCX</button>
                    </div>
                </div>
                <div class="analysis-output" id="analysis-output">
                    <!-- Content generated here -->
                </div>
            </section>
        </main>

        <!-- Tab Content: User Guide Carousel -->
        <main id="tab-guide" class="tab-content">
            <div class="guide-carousel-container">
                
                <!-- Controls -->
                <button class="carousel-btn prev" id="guide-prev"><i class="fas fa-chevron-left"></i></button>
                <button class="carousel-btn next" id="guide-next"><i class="fas fa-chevron-right"></i></button>
                
                <div class="carousel-nav" id="guide-dots">
                    <!-- Dots generated by JS -->
                </div>

                <!-- Track -->
                <div class="guide-track" id="guide-track">
                    
                    <!-- Slide 1: Intro & Setup -->
                    <div class="guide-slide">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <i class="fas fa-rocket" style="font-size: 4rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                            <h2>Getting Started</h2>
                            <p style="font-size: 1.1rem; color: var(--text-secondary);">Follow these 3 simple steps to start analyzing securely.</p>
                        </div>
                        
                        <div style="display: grid; gap: 1.5rem;">
                            <div style="display: flex; align-items: flex-start; gap: 1rem;">
                                <span class="step-number">1</span>
                                <div>
                                    <strong>Install LM Studio</strong>
                                    <p>Download it from lmstudio.ai. This software allows you to run AI models on your own computer.</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: flex-start; gap: 1rem;">
                                <span class="step-number">2</span>
                                <div>
                                    <strong>Load a Model & Start Server</strong>
                                    <p>Download a model like "Llama 3 8B". Go to the <strong>Local Server</strong> tab (left sidebar) and click <span style="color:var(--success-color); font-weight:bold;">Start Server</span>.</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: flex-start; gap: 1rem;">
                                <span class="step-number">3</span>
                                <div>
                                    <strong>Connect & Analyze</strong>
                                    <p>Come back here, click the refresh icon <i class="fas fa-sync-alt"></i> in the config box, select your model, and hit Analyze!</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Slide 2: Modules -->
                    <div class="guide-slide">
                        <h2 style="text-align: center;">Understanding the Modules</h2>
                        <p style="text-align: center; color: var(--text-secondary); margin-bottom: 2rem;">What each analysis option actually does for you.</p>
                        
                        <div class="guide-grid">
                            <div class="guide-card">
                                <i class="fas fa-user-check" style="color: var(--primary-color)"></i>
                                <h4>Ideal Persona</h4>
                                <p>Psychological profile of the perfect hire. Are they a leader or a follower?</p>
                            </div>
                            <div class="guide-card">
                                <i class="fas fa-language" style="color: var(--warning-color)"></i>
                                <h4>Jargon Decoder</h4>
                                <p>Translates "Fast-paced" to "High Stress". Know what you're signing up for.</p>
                            </div>
                            <div class="guide-card">
                                <i class="fas fa-exclamation-triangle" style="color: var(--error-color)"></i>
                                <h4>Red Flags</h4>
                                <p>Scans for toxicity, poor work-life balance, and vague requirements.</p>
                            </div>
                            <div class="guide-card">
                                <i class="fas fa-comments" style="color: var(--success-color)"></i>
                                <h4>Interview Prep</h4>
                                <p>Generates custom interview questions specifically for this role.</p>
                            </div>
                            <div class="guide-card">
                                <i class="fas fa-money-bill-wave" style="color: var(--warning-color)"></i>
                                <h4>Seniority & Pay</h4>
                                <p>Estimates true seniority level and expected salary range based on responsibilities.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Slide 3: Troubleshooting -->
                    <div class="guide-slide">
                        <h2 style="text-align: center; color: var(--error-color);">Troubleshooting</h2>
                        <div style="max-width: 600px; margin: 0 auto; margin-top: 2rem;">
                            <h3 style="border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem;">"Disconnected" Status?</h3>
                            <ul style="list-style: none; padding: 0; margin-top: 1rem;">
                                <li style="margin-bottom: 1rem; padding: 1rem; background: #fff1f2; border-radius: 6px; border: 1px solid #fecdd3;">
                                    <strong><i class="fas fa-check-circle"></i> Check Server Status</strong><br>
                                    Is the green bar active in LM Studio's "Local Server" tab?
                                </li>
                                <li style="margin-bottom: 1rem; padding: 1rem; background: #fff1f2; border-radius: 6px; border: 1px solid #fecdd3;">
                                    <strong><i class="fas fa-globe"></i> CORS Settings</strong><br>
                                    In LM Studio Server Options (right sidebar), ensure <strong>CORS</strong> is enabled. This allows the browser to talk to the server.
                                </li>
                                <li style="margin-bottom: 1rem; padding: 1rem; background: #fff1f2; border-radius: 6px; border: 1px solid #fecdd3;">
                                    <strong><i class="fas fa-link"></i> Port Mismatch</strong><br>
                                    Default port is <code>1234</code>. If you changed it in LM Studio, update the Base URL in this tool.
                                </li>
                            </ul>
                        </div>
                    </div>

                </div>
            </div>
        </main>

        <footer style="text-align: center; color: var(--text-secondary); padding: 2rem; font-size: 0.9rem;">
            &copy; 2025 JD Deep Analyzer. Private Local Analysis.
        </footer>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script>
        class JDAnalyzer {
            constructor() {
                this.initializeElements();
                this.setupListeners();
                this.setupTabs();
                this.setupCarousel(); // Initialize Carousel
                this.loadSettings();
                this.validateState();
            }

            initializeElements() {
                // Inputs
                this.jdInput = document.getElementById('jd-input');
                this.additionalFocus = document.getElementById('additional-focus');
                this.lmBaseUrl = document.getElementById('lm-base-url');
                this.modelSelect = document.getElementById('lm-model-select');
                
                // Buttons
                this.refreshBtn = document.getElementById('refresh-models-btn');
                this.analyzeBtn = document.getElementById('analyze-btn');
                this.clearBtn = document.getElementById('clear-btn');
                this.copyBtn = document.getElementById('copy-btn');
                this.exportDocxBtn = document.getElementById('export-docx-btn');
                
                // Options
                this.opts = {
                    core: document.getElementById('opt-core-analysis'),
                    persona: document.getElementById('opt-candidate-persona'),
                    decoder: document.getElementById('opt-corporate-decoder'),
                    redFlags: document.getElementById('opt-red-flags'),
                    interview: document.getElementById('opt-interview-prep'),
                    salary: document.getElementById('opt-salary-est')
                };

                // UI
                this.resultsSection = document.getElementById('results-section');
                this.analysisOutput = document.getElementById('analysis-output');
                this.charCount = document.getElementById('jd-char-count');
                this.connectionStatus = document.getElementById('connection-status');
                this.modelStatus = document.getElementById('model-status');
            }

            setupListeners() {
                this.refreshBtn.addEventListener('click', () => this.fetchModels());
                this.analyzeBtn.addEventListener('click', () => this.runAnalysis());
                this.clearBtn.addEventListener('click', () => this.clearAll());
                this.jdInput.addEventListener('input', () => {
                    this.charCount.textContent = `${this.jdInput.value.length} characters`;
                    this.validateState();
                });
                this.modelSelect.addEventListener('change', () => {
                    localStorage.setItem('selectedModel', this.modelSelect.value);
                    this.updateStatusUI(true, this.modelSelect.value);
                    this.validateState();
                });
                this.copyBtn.addEventListener('click', () => this.copyResults());
                this.exportDocxBtn.addEventListener('click', () => this.exportDocx());
            }

            setupTabs() {
                const tabs = document.querySelectorAll('.tab-btn');
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        tab.classList.add('active');
                        const targetId = `tab-${tab.dataset.tab}`;
                        document.getElementById(targetId).classList.add('active');
                    });
                });
            }

            setupCarousel() {
                const track = document.getElementById('guide-track');
                const slides = Array.from(track.children);
                const nextBtn = document.getElementById('guide-next');
                const prevBtn = document.getElementById('guide-prev');
                const dotsNav = document.getElementById('guide-dots');
                
                let currentSlideIndex = 0;

                // Create dots
                slides.forEach((_, index) => {
                    const dot = document.createElement('button');
                    dot.classList.add('carousel-dot');
                    if (index === 0) dot.classList.add('active');
                    dot.addEventListener('click', () => moveToSlide(index));
                    dotsNav.appendChild(dot);
                });
                
                const dots = Array.from(dotsNav.children);

                const updateCarousel = () => {
                    const amountToMove = -100 * currentSlideIndex;
                    track.style.transform = `translateX(${amountToMove}%)`;
                    
                    dots.forEach(d => d.classList.remove('active'));
                    dots[currentSlideIndex].classList.add('active');
                };

                const moveToSlide = (index) => {
                    currentSlideIndex = index;
                    if (currentSlideIndex < 0) currentSlideIndex = slides.length - 1;
                    if (currentSlideIndex >= slides.length) currentSlideIndex = 0;
                    updateCarousel();
                };

                nextBtn.addEventListener('click', () => moveToSlide(currentSlideIndex + 1));
                prevBtn.addEventListener('click', () => moveToSlide(currentSlideIndex - 1));
            }

            validateState() {
                const hasJD = this.jdInput.value.trim().length > 10;
                const hasModel = this.modelSelect.value !== "";
                
                if (!hasModel) {
                    this.analyzeBtn.disabled = true;
                    this.analyzeBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Select Model First';
                } else if (!hasJD) {
                    this.analyzeBtn.disabled = true;
                    this.analyzeBtn.innerHTML = '<i class="fas fa-pen"></i> Enter Job Description';
                } else {
                    this.analyzeBtn.disabled = false;
                    this.analyzeBtn.innerHTML = '<i class="fas fa-brain"></i> Analyze Job Description';
                }
            }

            async fetchModels() {
                this.refreshBtn.classList.add('spinner');
                try {
                    const response = await fetch(`${this.lmBaseUrl.value}/v1/models`);
                    if(!response.ok) throw new Error('Failed to connect');
                    
                    const data = await response.json();
                    const models = data.data || [];
                    
                    this.modelSelect.innerHTML = '<option value="">Select a model...</option>';
                    models.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.textContent = m.id;
                        this.modelSelect.appendChild(opt);
                    });

                    // Restore selection
                    const saved = localStorage.getItem('selectedModel');
                    if(saved && models.some(m => m.id === saved)) {
                        this.modelSelect.value = saved;
                        this.updateStatusUI(true, saved);
                    } else {
                        this.updateStatusUI(true, null);
                    }
                    this.showToast(`Found ${models.length} models`, 'success');
                } catch (e) {
                    this.showToast('Connection failed. Is LM Studio running?', 'error');
                    this.updateStatusUI(false);
                } finally {
                    this.refreshBtn.classList.remove('spinner');
                    this.validateState();
                }
            }

            updateStatusUI(connected, modelName) {
                const dot = this.connectionStatus.querySelector('.status-dot');
                const text = this.connectionStatus.querySelector('span');
                const modelText = this.modelStatus.querySelector('span');

                if(connected) {
                    dot.className = 'fas fa-circle status-dot connected';
                    text.textContent = 'LM Studio: Connected';
                    modelText.textContent = modelName ? `Model: ${modelName}` : 'Select a Model';
                } else {
                    dot.className = 'fas fa-circle status-dot disconnected';
                    text.textContent = 'LM Studio: Disconnected';
                    modelText.textContent = 'No Model';
                }
            }

            buildPrompt() {
                const jd = this.jdInput.value;
                const extra = this.additionalFocus.value;
                
                let prompt = `You are an expert HR Consultant and Technical Recruiter. I will provide a Job Description (JD). Please analyze it thoroughly based on the requested sections below.\n\n`;
                
                prompt += `JOB DESCRIPTION:\n"""${jd}"""\n\n`;
                if(extra) prompt += `ADDITIONAL USER QUESTIONS: ${extra}\n\n`;

                prompt += `Please generate the following analysis sections in Markdown format (Use H2 ## for headers):\n\n`;

                if(this.opts.core.checked) {
                    prompt += `## 1. CORE COMPETENCIES BREAKDOWN
- **Technical/Hard Skills:** List specific tools, languages, and frameworks ranked by implied importance.
- **Soft Skills:** List the interpersonal traits required.
- **Key Responsibilities:** Summarize the day-to-day work in bullet points.
- **Education/Experience:** Clarify the "must-haves" vs "nice-to-haves".\n\n`;
                }

                if(this.opts.persona.checked) {
                    prompt += `## 2. IDEAL CANDIDATE PERSONA
Describe the profile of the person who gets hired. Not just skills, but their mindset, their background, and how they approach problems. Use professional psychological profiling terms if applicable (e.g., "High agency," "Growth mindset").\n\n`;
                }

                if(this.opts.decoder.checked) {
                    prompt += `## 3. CORPORATE JARGON DECODER
Identify the jargon phrases or buzzwords in the text (e.g., "fast-paced," "rockstar," "wear many hats").
- **Phrase:** [The phrase]
- **Translation:** [What it actually means pragmatically]
- **Implication:** [What this means for the daily workload]\n\n`;
                }

                if(this.opts.redFlags.checked) {
                    prompt += `## 4. RED FLAGS & CULTURE CHECK
Analyze the text for potential warning signs:
- Unrealistic requirements or expectations (unicorn hunting).
- Signs of challenging work-life balance.
- Internal text contradictions (for example senior level requirements for junior role)
- Vague role definitions (scope creep potential).
- Role boundary definition
- Give a "Stress Score" estimate (1-10) with reasoning.\n\n`;
                }

                if(this.opts.salary.checked) {
                    prompt += `## 5. SENIORITY & MARKET POSITIONING
Based on the responsibilities (not just the title):
- Estimated Seniority Level (Junior, Mid, Senior, Lead, Principal) as derives from the job requirements.
- Estimated Salary Bracket (Low, Avg, High for this role type - generic relative terms if currency is unknown).
- What new professional skills or competences one can learn if getting the position.
- What skills and competences one can develop if getting this position.
- Career Growth Potential (Does this role lead somewhere?).\n\n`;
                }

                if(this.opts.interview.checked) {
                    prompt += `## 6. INTERVIEW PREPARATION
Based specifically on the requirements above, generate:
- 5 Technical/Hard Skill Questions likely to be asked.
- 5 Behavioral/Soft Skill Questions (STAR method style).
- 5 Questions the *Candidate* should ask the interviewer to impress them.\n\n`;
                }

                return prompt;
            }

            async runAnalysis() {
                const prompt = this.buildPrompt();
                this.analyzeBtn.disabled = true;
                this.analyzeBtn.innerHTML = '<i class="fas fa-spinner spinner"></i> Analyzing...';
                
                if(!document.getElementById('tab-analyzer').classList.contains('active')) {
                   document.querySelector('[data-tab="analyzer"]').click(); 
                }

                this.resultsSection.style.display = 'none';
                this.analysisOutput.innerHTML = '';

                try {
                    const response = await fetch(`${this.lmBaseUrl.value}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: this.modelSelect.value,
                            messages: [
                                { role: "system", content: "You are an expert Job Description analyst. Output clean Markdown." },
                                { role: "user", content: prompt }
                            ],
                            temperature: 0.7,
                            max_tokens: -1, // Unlimited depending on model
                            stream: false
                        })
                    });

                    if(!response.ok) throw new Error('API Error');
                    const data = await response.json();
                    const content = data.choices[0].message.content;
                    
                    this.renderResults(content);
                    this.showToast('Analysis Complete', 'success');
                } catch (e) {
                    console.error(e);
                    this.showToast('Analysis failed: ' + e.message, 'error');
                } finally {
                    this.validateState();
                }
            }

            renderResults(markdown) {
                let html = markdown
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                    .replace(/\*(.*)\*/gim, '<em>$1</em>')
                    .replace(/^\- (.*$)/gim, '<li>$1</li>')
                    .replace(/\n/gim, '<br>');
                
                html = html.replace(/(<li>.*<\/li>)/gim, '<ul>$1</ul>').replace(/<\/ul><br><ul>/gim, '');
                
                this.analysisOutput.innerHTML = html;
                this.resultsSection.style.display = 'block';
                this.resultsSection.scrollIntoView({ behavior: 'smooth' });
                
                this.lastRawText = markdown;
            }

            copyResults() {
                if(!this.lastRawText) return;
                navigator.clipboard.writeText(this.lastRawText);
                this.showToast('Copied to clipboard', 'success');
            }

            exportDocx() {
                if(!this.analysisOutput.innerHTML) return;
                
                const content = `
                    <!DOCTYPE html>
                    <html><head><style>body { font-family: Arial; }</style></head>
                    <body>
                        <h1>Job Description Analysis</h1>
                        ${this.analysisOutput.innerHTML}
                    </body></html>
                `;
                
                const blob = window.htmlDocx.asBlob(content);
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'JD_Analysis.docx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                this.showToast('DOCX Downloaded', 'success');
            }

            clearAll() {
                this.jdInput.value = '';
                this.additionalFocus.value = '';
                this.resultsSection.style.display = 'none';
                this.validateState();
            }

            loadSettings() {
                const savedModel = localStorage.getItem('selectedModel');
                if(savedModel) {
                    this.fetchModels();
                }
            }

            showToast(msg, type) {
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                t.innerText = msg;
                document.getElementById('toast-container').appendChild(t);
                setTimeout(() => t.remove(), 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.app = new JDAnalyzer();
        });
    </script>
</body>
</html>